From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: booky10 <boooky10@gmail.com>
Date: Fri, 20 Sep 2024 01:13:04 +0200
Subject: [PATCH] Further improve Player#canSee performance


diff --git a/net/minecraft/world/entity/Entity.java b/net/minecraft/world/entity/Entity.java
index 65635c24785162a14a220e0897aa222557e85989..3d3330ef5f3fcdcc45bb8b5fd66c03087269c96d 100644
--- a/net/minecraft/world/entity/Entity.java
+++ b/net/minecraft/world/entity/Entity.java
@@ -318,6 +318,15 @@ public abstract class Entity implements SyncedDataHolder, DebugValueSource, Name
     private boolean invulnerable;
     protected UUID uuid = Mth.createInsecureUUID(this.random);
     protected String stringUUID = this.uuid.toString();
+    // CloudPlane start - further improve Player#canSee performance;
+    // combine UUID to single value to allow for easier hashmap lookups
+    // and allow using fastutil number sets
+    // this is less "secure" than using a full UUID, but should still not cause
+    // any collisions on this non-distributed system
+    // there may be a slight chance for collision, but this chance
+    // is way too small to actually account for
+    public long longUUID = this.uuid.getMostSignificantBits() ^ this.uuid.getLeastSignificantBits();
+    // CloudPlane end - further improve Player#canSee performance
     private boolean hasGlowingTag;
     private final Set<String> tags = new io.papermc.paper.util.SizeLimitedSet<>(new it.unimi.dsi.fastutil.objects.ObjectOpenHashSet<>(), MAX_ENTITY_TAG_COUNT); // Paper - fully limit tag size - replace set impl
     private final double[] pistonDeltas = new double[]{0.0, 0.0, 0.0};
@@ -544,6 +553,7 @@ public abstract class Entity implements SyncedDataHolder, DebugValueSource, Name
         this.position = Vec3.ZERO;
         this.blockPosition = BlockPos.ZERO;
         this.chunkPosition = ChunkPos.ZERO;
+        this.setUUID(this.uuid); // CloudPlane - further improve Player#canSee performance; call common setter
         // Paper start - EAR 2
         if (level != null) {
             this.defaultActivationState = io.papermc.paper.entity.activation.ActivationRange.initializeEntityActivationState(this, level.spigotConfig);
@@ -2666,8 +2676,7 @@ public abstract class Entity implements SyncedDataHolder, DebugValueSource, Name
             this.invulnerable = input.getBooleanOr("Invulnerable", false);
             this.portalCooldown = input.getIntOr("PortalCooldown", 0);
             input.read("UUID", UUIDUtil.CODEC).ifPresent(uuid -> {
-                this.uuid = uuid;
-                this.stringUUID = this.uuid.toString();
+                this.setUUID(uuid); // CloudPlane - further improve Player#canSee performance; call common setter
             });
             if (!Double.isFinite(this.getX()) || !Double.isFinite(this.getY()) || !Double.isFinite(this.getZ())) {
                 throw new IllegalStateException("Entity has invalid position");
@@ -4258,6 +4267,9 @@ public abstract class Entity implements SyncedDataHolder, DebugValueSource, Name
     public void setUUID(UUID uuid) {
         this.uuid = uuid;
         this.stringUUID = this.uuid.toString();
+        // CloudPlane start - further improve Player#canSee performance
+        this.longUUID = this.uuid.getMostSignificantBits() ^ this.uuid.getLeastSignificantBits();
+        // CloudPlane end - further improve Player#canSee performance
     }
 
     @Override
@@ -4269,6 +4281,12 @@ public abstract class Entity implements SyncedDataHolder, DebugValueSource, Name
         return this.stringUUID;
     }
 
+    // CloudPlane start - further improve Player#canSee performance
+    public final long getLongUUID() {
+        return this.longUUID;
+    }
+    // CloudPlane end - further improve Player#canSee performance
+
     @Override
     public String getScoreboardName() {
         return this.stringUUID;
